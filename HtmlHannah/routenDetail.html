<!Doctype html>
<html lang="de">

	<head>
		<title>Klettertourenbuch Kuchl</title>
		<meta charset="utf-8">
		<link rel="stylesheet" href="routenDetail.css">
		<link rel="stylesheet" href="2.Ebene.css">

	</head>

	<!--                       LOGIN                     -->
	<script>
        function logIn(){
            usrName = document.getElementById("userName").value;
            pw = document.getElementById("pw").value;

            if(isValidText(pw)==true){
                alert("invalid PW");
                return 0;
            }
            if(isValidText(usrName)==true){
                alert("invalid Name");
                return 0;
            }

            //check if the password is correct!
            var xhttp = new XMLHttpRequest();
            xhttp.onload = function () {
                if(this.responseText=="OK"){

                    //first log out(delet all cookies)
                    deleteAllCookies();
                    document.cookie = usrName + '=' + pw+";path=/";
                    alert("Angemeldet!");
                }else{
                    alert("Falscher Benutzername oder falsches Passwort");
                }

            };
            xhttp.open("GET","http://localhost:8000/Php/checkPassword.php?+name="+usrName+"&pw="+pw, true);
            xhttp.send();
        }



        function deleteAllCookies() {
            var cookies = document.cookie.split(";");

            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i];
                var eqPos = cookie.indexOf("=");
                var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;Path=/";
            }
        }

        function isValidText(name){
            //regexp
            var pat = /[äöüß?=&<\\;]/i;
            return pat.test(name);
        }
        

    </script>
		
	<body>

		<div class="navigation">
			<ul>
				<li><a href="home.html">Home</a></li>
				<li><a href="touren.html">Routen</a></li>
				<li><a href="meinegeKlettertenTouren.html">Meine gekletterten Touren</a></li>
				<li><a href="register.html">Registrieren</a></li>
				<li class="anmelden" style="float:right" onclick="logIn()">Anmelden</li>
				<li class="anmelden nohover" style="float:right">Passwort <input type="text" class="textfeld" id="pw"></li>	
				<li class="anmelden nohover" style="float:right">User Name <input type="text" class="textfeld" id="userName"></li>
			</ul>
		</div>
		
		<div class="ueberschrift">
			<h1>Mein Kletterntourenbuch Kuchl</h1>
		</div>
		
		<div class="detail">
		
			<h3 id="name"></h3>
			<img id="img" src=".." alt="Bild der Tour">
			<p id="diff"><b>Schwierigkeit:</b>	 </p>
			<p id="color"><b>Farbe:</b>			 </p>
			
		</div>
		
		<div class="kommentare">
		
			<hr>
			<h4>Kommentare</h4> <button onClick="sendAcces()">Kommentar hinzufügen</button> <!-- zu Kommentarhinzufügen.html-->
			<table id="t01">
				<tr>
					<th>Name</th>
					<th>Kommentar</th>
					<th>Schwierigkeitsbewertung</th>
				</tr>		  
			</table>
		
		</div>
		
	</body>

	<script>
        //get the tour Name
        o = sessionStorage.getItem('tour');
        getTourInfo(o);
        

        function setTableContent(text){
            spl = text.split("||");
            Rname = spl[0];
            color = spl[1];
            diff = spl[2];
            //load the info
            document.getElementById("name").innerHTML += Rname;
            document.getElementById("color").innerHTML += color;
            document.getElementById("diff").innerHTML += diff;
            //load the image
            document.getElementById("img").src = "/Routen/"+(Rname.replace(/ /g, ''))+"/pic.jpeg";

            //check if the user is logged in
				listOfCookies = decodeURIComponent(document.cookie).split(";");
				if(listOfCookies[0] == ""){
					alert("Bitte Einloggen!");
					return 0;
				}
				//There is a log in cookie
				usrName = listOfCookies[0].split("=")[0];
				pw = listOfCookies[0].split("=")[1];


			//Call the php function (getListOfTours())
			var Http = new XMLHttpRequest();
            console.log(Rname);
			var url="http://localhost:8000/Php/filterAccents.php?filter="+Rname.trim()+"||--||--||--||--||--";
			Http.open("GET", url,true);

			Http.onload = function () {
				//"draw" the table form the php function
				parts = (Http.responseText).split("\n");
				parts.splice(parts.length-1,1);
				string = "";
				for(i = 0; i< parts.length; i++){
					description = parts[i];
					info = description.split("||");
					string += "<tr>";
					string += "<td>"+info[2]+"</td>";
					string += "<td>"+info[3]+"</td>";
					string += "<td>"+info[4]+"<img id='info' src=\"Bilder/info.png\"></td>";
					string += "</tr>";
						
				}
				document.getElementById("t01").innerHTML += string;
		    };
			Http.send();
        }
        


        function sendAcces(){
            sessionStorage.setItem('tourName', Rname);
            sessionStorage.setItem('tourDiff', diff);
            location.href = "/HtmlHannah/Kommentarhinzufügen.html";
        }

        function getTourInfo(tourname){
            //Call the php function (getListOfTours())
            var Http = new XMLHttpRequest();
            var url='http://localhost:8000/Php/getListOfTours.php?filter='+tourname+'||--||--';
            Http.open("GET", url,true);

            Http.onload = function () {
                //get the response text and return int
                setTableContent(Http.responseText);
            };

            Http.send();
        }


    </script>

	</html>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	